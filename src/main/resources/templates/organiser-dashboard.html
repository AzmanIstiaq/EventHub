<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Organiser Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background: #f5f7fa;
            color: #333;
        }

        .container {
            max-width: 1000px;
            margin: 2rem auto;
            padding: 1rem;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        h1 { margin: 0; }

        .btn {
            padding: 0.4rem 0.8rem;
            border: none;
            border-radius: 6px;
            text-decoration: none;
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .btn-primary { background: #007bff; }
        .btn-edit { background: #28a745; }
        .btn-delete { background: #dc3545; }
        .btn-cancel { background: #6c757d; }

        .events-grid {
            display: grid;
            gap: 1.5rem;
        }

        .event-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            padding: 1rem 1.5rem;
        }

        .event-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .event-meta {
            font-size: 0.9rem;
            color: #666;
        }

        .toggle-btn {
            margin-top: 1rem;
            background: #e9ecef;
            border: none;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .toggle-btn.active { background: #ced4da; }

        .registrations {
            margin-top: 0.8rem;
            padding-left: 1.2rem;
            list-style: disc;
        }

        .hidden { display: none; }

        .form-card {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            padding: 1rem 1.5rem;
            margin-bottom: 1.5rem;
        }

        .form-card label {
            display: block;
            margin: 0.5rem 0 0.2rem;
        }

        .form-card input, .form-card textarea {
            width: 100%;
            padding: 0.4rem;
            border: 1px solid #ccc;
            border-radius: 6px;
        }

        .form-actions {
            margin-top: 1rem;
            display: flex;
            gap: 0.5rem;
        }

        .empty-message {
            font-style: italic;
            color: #666;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
<div th:replace="~{fragments/navbar}"></div>

<div class="container">
    <header>
        <h1 th:text="'Events for ' + ${organiser.name}"></h1>
        <button id="create-btn" class="btn btn-primary">+ Create New Event</button>
    </header>

    <!-- Hidden Create Event Form -->
    <div id="create-form" class="form-card hidden">
        <h2>Create Event</h2>
        <form th:action="@{'/organiser/' + ${organiser.id} + '/events'}" method="post" onsubmit="return validateEventForm(this)">
            <label>Title:</label>
            <input type="text" name="title" required>

            <label>Description:</label>
            <textarea name="description" required></textarea>

            <label>Date/Time:</label>
            <input type="datetime-local" name="dateTime" required>

            <label>Location:</label>
            <input type="text" name="location" required>

            <!-- Category -->
            <label>Category:</label>
            <select name="category.id" required>
                <option value="" disabled selected>Select category</option>
                <option th:each="cat : ${categories}" th:value="${cat.id}" th:text="${cat.name}"></option>
            </select>

            <!-- Keywords (comma-separated) -->
            <label>Keywords (comma-separated):</label>
            <input type="text" name="keywordsText" placeholder="e.g. Music, Workshop, Tech">

            <div class="form-actions">
                <button type="submit" class="btn btn-primary">Save</button>
                <button type="button" class="btn btn-cancel" onclick="cancelCreateForm()">Cancel</button>
            </div>
        </form>
    </div>

    <h2>Upcoming Events</h2>
    <div th:if="${#lists.isEmpty(upcomingEvents)}" class="empty-message">
        There are no upcoming events.
    </div>
    <div class="events-grid" th:unless="${#lists.isEmpty(upcomingEvents)}">
        <div class="event-card" th:each="event : ${upcomingEvents}">
            <!-- Inline edit form -->
            <div th:id="'form-' + ${event.id}" class="form-card hidden">
                <h2>Edit Event</h2>
                <form th:action="@{'/organiser/' + ${organiser.id} + '/events/' + ${event.id} + '/edit'}"
                      method="post" onsubmit="return validateEventForm(this)">
                    <label>Title:</label>
                    <input type="text" name="title" th:value="${event.title}" required>

                    <label>Description:</label>
                    <textarea name="description" required
                              th:text="${event.description}"></textarea>

                    <label>Date/Time:</label>
                    <input type="datetime-local" name="dateTime"
                           th:value="${#temporals.format(event.dateTime, 'yyyy-MM-dd''T''HH:mm')}"
                           required>

                    <label>Location:</label>
                    <input type="text" name="location" th:value="${event.location}" required>

                    <select name="category.id" required>
                        <option value="" disabled>Select category</option>
                        <option th:each="cat : ${categories}"
                                th:value="${cat.id}"
                                th:text="${cat.name}"
                                th:selected="${event.category != null and cat.id == event.category.id}">
                        </option>
                    </select>


                    <!-- Keywords (comma-separated) -->
                    <label>Keywords (comma-separated):</label>
                    <input type="text" name="keywordsText" th:value="${event.getKeywordsAsString()}" placeholder="e.g. Music, Workshop, Tech">

                    <button type="submit">Save</button>
                    <button type="button" th:onclick="'cancelEditForm(' + ${event.id} + ')'">Cancel</button>
                </form>

            </div>

            <!-- Normal event display -->
            <div th:id="'card-' + ${event.id}">
                <div class="event-header">
                    <h2 th:text="${event.title}"></h2>
                    <div class="event-actions">
                        <button class="btn btn-edit"
                                th:if="${event.dateTime.isAfter(T(java.time.LocalDateTime).now())}"
                                th:onclick="'showEditForm(' + ${event.id} + ')'">Edit</button>
                        <a class="btn btn-delete"
                           th:href="@{'/organiser/' + ${organiser.id} + '/events/' + ${event.id} + '/delete'}">Delete</a>
                    </div>
                </div>
                <p class="event-meta">
                    <span th:text="${event.dateTime}"></span> @
                    <span th:text="${event.location}"></span><br>
                    <strong th:if="${event.getCategory() != null}">Category:</strong> <span th:text="${event.getCategory()?.getName()}"></span><br>
                    <strong th:if="${!#lists.isEmpty(event.keywords)}">Keywords:</strong>
                    <span th:each="kw, iterStat : ${event.keywords}">
                        <span th:text="${kw.name}"></span><span th:if="${!iterStat.last}">, </span>
                    </span>
                </p>


                <button class="toggle-btn">Show Registrations ▼</button>
                <ul class="registrations hidden">
                    <li th:each="registration : ${event.registrations}">
                        <strong th:text="${registration.getUser().getName()}"></strong>
                        (<span th:text="${registration.getRegistrationDate()}"></span>)
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <h2>Past Events</h2>
    <div th:if="${#lists.isEmpty(pastEvents)}" class="empty-message">
        There are no past events.
    </div>
    <div class="events-grid" th:unless="${#lists.isEmpty(pastEvents)}">
        <div class="event-card" th:each="event : ${pastEvents}">
            <div class="event-header">
                <h2 th:text="${event.title}"></h2>
                <div class="event-actions">
                    <a class="btn btn-delete"
                       th:href="@{'/organiser/' + ${organiser.id} + '/events/' + ${event.id} + '/delete'}">Delete</a>
                </div>
            </div>
            <p class="event-meta">
                <span th:text="${event.dateTime}"></span> @
                <span th:text="${event.location}"></span><br>
                <strong th:if="${event.category != null}">Category:</strong> <span th:text="${event.category.getName()}"></span><br>
                <strong th:if="${!#lists.isEmpty(event.keywords)}">Keywords:</strong>
                <span th:each="kw, iterStat : ${event.keywords}">
                    <span th:text="${kw.name}"></span><span th:if="${!iterStat.last}">, </span>
                </span>
            </p>


            <button class="toggle-btn">Show Registrations ▼</button>
            <ul class="registrations hidden">
                <li th:each="registration : ${event.registrations}">
                    <strong th:text="${registration.getUser().getName()}"></strong>
                    (<span th:text="${registration.getRegistrationDate()}"></span>)
                </li>
            </ul>
        </div>
    </div>
</div>

<script>
    // Toggle registration lists
    document.addEventListener("DOMContentLoaded", () => {
        const toggleButtons = document.querySelectorAll(".toggle-btn");
        toggleButtons.forEach(btn => {
            btn.addEventListener("click", () => {
                const registrations = btn.nextElementSibling;
                const isHidden = registrations.classList.contains("hidden");
                registrations.classList.toggle("hidden", !isHidden);
                btn.classList.toggle("active", isHidden);
                btn.textContent = isHidden ? "Hide Registrations ▲" : "Show Registrations ▼";
            });
        });

        // Create form toggle
        document.getElementById("create-btn").addEventListener("click", () => {
            document.getElementById("create-form").classList.toggle("hidden");
        });
    });

    // Cancel Create
    function cancelCreateForm() {
        const formWrapper = document.getElementById("create-form");
        formWrapper.classList.add("hidden");
        formWrapper.querySelector("form").reset();
    }

    // Show inline edit form
    function showEditForm(eventId) {
        document.getElementById("card-" + eventId).classList.add("hidden");
        document.getElementById("form-" + eventId).classList.remove("hidden");
    }

    // Cancel inline edit
    function cancelEditForm(eventId) {
        document.getElementById("form-" + eventId).classList.add("hidden");
        document.getElementById("card-" + eventId).classList.remove("hidden");
    }

    // Validate form before submit
    function validateEventForm(form) {
        const title = form.querySelector("input[name='title']");
        const desc = form.querySelector("textarea[name='description']");
        const dateTime = form.querySelector("input[name='dateTime']");
        const location = form.querySelector("input[name='location']");

        if (!title.value.trim() || !desc.value.trim() || !dateTime.value || !location.value.trim()) {
            alert("All fields are required.");
            return false;
        }

        const enteredDate = new Date(dateTime.value);
        if (enteredDate <= new Date()) {
            alert("Event date and time must be in the future.");
            return false;
        }

        return true;
    }
</script>
</body>
</html>
